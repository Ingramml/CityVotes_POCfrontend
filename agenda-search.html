<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Item Search - CityVotes Santa Ana</title>
    <meta name="description" content="Search Santa Ana City Council agenda items by keyword with advanced filters.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Agenda Item Search - CityVotes Santa Ana">
    <meta property="og:description" content="Search Santa Ana City Council agenda items by keyword with advanced filters.">
    <meta property="og:site_name" content="CityVotes">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Agenda Item Search - CityVotes Santa Ana">
    <meta name="twitter:description" content="Search Santa Ana City Council agenda items by keyword with advanced filters.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link href="css/santa-ana.css" rel="stylesheet">
    <style>
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: rgba(0,0,0,0.05); }
        .sort-icon { opacity: 0.3; margin-left: 5px; }
        .sortable.active .sort-icon { opacity: 1; }
        .kpi-card { border-left: 4px solid; }
        .kpi-card.meetings { border-left-color: var(--bs-primary); }
        .kpi-card.votes { border-left-color: var(--bs-success); }
        .table th { white-space: nowrap; }
        .filter-row { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <!-- Skip Navigation -->
    <a href="#main-content" class="visually-hidden-focusable skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-sa-blue">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-vote-yea me-2"></i>CityVotes
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="council.html">
                            <i class="fas fa-users me-1"></i>Council
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="meetings.html">
                            <i class="fas fa-calendar me-1"></i>Meetings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="votes.html">
                            <i class="fas fa-check-square me-1"></i>Votes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="agenda-search.html">
                            <i class="fas fa-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
                <a href="about.html" class="btn btn-outline-light btn-sm me-3">
                    <i class="fas fa-question-circle me-1"></i>Help
                </a>
                <span class="navbar-text text-sa-gold">
                    <i class="fas fa-map-marker-alt me-1"></i>Santa Ana
                </span>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="bg-light py-4">
        <div class="container">
            <h1><i class="fas fa-search me-2"></i>Agenda Item Search</h1>
            <p class="text-muted mb-0">Search and filter agenda items across all meetings</p>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container my-4">
        <!-- KPI Dashboard -->
        <div class="row mb-4" id="kpiSection">
            <div class="col-md-3 col-6 mb-3">
                <div class="card kpi-card meetings h-100">
                    <div class="card-body text-center">
                        <h3 class="text-primary mb-1" id="kpiMeetings">--</h3>
                        <small class="text-muted">Meetings</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card kpi-card votes h-100">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-1" id="kpiVotes">--</h3>
                        <small class="text-muted">Total Votes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h3 class="text-info mb-1" id="kpiPassRate">--%</h3>
                        <small class="text-muted">Pass Rate</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h3 class="text-secondary mb-1" id="kpiFiltered">--</h3>
                        <small class="text-muted">Showing</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body filter-row">
                <form id="searchForm" class="row g-2 align-items-end" role="search">
                    <div class="col-lg-3 col-md-6">
                        <label for="searchInput" class="form-label small text-muted mb-1">Search</label>
                        <div class="input-group">
                            <span class="input-group-text" aria-hidden="true"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput"
                                   placeholder="Keywords..."
                                   autocomplete="off" aria-label="Search agenda items by keyword">
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label for="topicFilter" class="form-label small text-muted mb-1">Topic/Section</label>
                        <select class="form-select" id="topicFilter" aria-label="Filter by topic">
                            <option value="">All Topics</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label for="yearFilter" class="form-label small text-muted mb-1">Year</label>
                        <select class="form-select" id="yearFilter" aria-label="Filter by year">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label for="meetingTypeFilter" class="form-label small text-muted mb-1">Meeting Type</label>
                        <select class="form-select" id="meetingTypeFilter" aria-label="Filter by meeting type">
                            <option value="">All Types</option>
                            <option value="regular">Regular</option>
                            <option value="special">Special</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3 col-6">
                        <label for="outcomeFilter" class="form-label small text-muted mb-1">Outcome</label>
                        <select class="form-select" id="outcomeFilter" aria-label="Filter by outcome">
                            <option value="">All Outcomes</option>
                            <option value="PASS">Passed</option>
                            <option value="FAIL">Failed</option>
                        </select>
                    </div>
                    <div class="col-lg-1 col-md-2 col-6">
                        <button type="button" class="btn btn-outline-secondary w-100" id="clearFilters" aria-label="Clear all filters">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="resultsTable">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="sortable" data-sort="meeting_date">
                                Date <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable" data-sort="item_number">
                                Item <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable" data-sort="title">
                                Title <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable" data-sort="section">
                                Topic <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable" data-sort="meeting_type">
                                Type <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable" data-sort="outcome">
                                Result <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading agenda items...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="mt-4" id="paginationNav" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>CityVotes - Santa Ana Voting Transparency</h6>
                    <p class="text-muted mb-0">Data sourced from official Santa Ana city council meeting records.</p>
                </div>
                <div class="col-md-4 text-end">
                    <p class="mb-0">Want a different city? <a href="contact.html" class="text-sa-gold">Contact us</a></p>
                </div>
                <div class="col-md-2 text-end">
                    <span class="text-muted" id="footerYears">2022-2024 Data</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Static Data API -->
    <script src="js/api.js"></script>

    <script>
    // State
    let allVotes = [];
    let filteredVotes = [];
    let availableYears = [];
    let availableTopics = [];
    let currentOffset = 0;
    const pageSize = 25;
    let sortColumn = 'meeting_date';
    let sortDirection = 'desc';

    document.addEventListener('DOMContentLoaded', async function() {
        await loadAllData();
        setupEventListeners();
        applyFiltersFromURL();
    });

    async function loadAllData() {
        try {
            const votesData = await CityVotesAPI.getVotes();
            allVotes = votesData.votes || [];

            // Extract unique years
            const years = new Set();
            const topics = new Set();
            allVotes.forEach(vote => {
                if (vote.meeting_date) {
                    years.add(new Date(vote.meeting_date).getFullYear());
                }
                if (vote.section) {
                    topics.add(vote.section);
                }
            });

            availableYears = Array.from(years).sort((a, b) => b - a);
            availableTopics = Array.from(topics).sort();

            // Populate dropdowns
            populateYearDropdown();
            populateTopicDropdown();

            // Update footer
            if (availableYears.length > 0) {
                const minYear = availableYears[availableYears.length - 1];
                const maxYear = availableYears[0];
                document.getElementById('footerYears').textContent =
                    minYear === maxYear ? `${minYear} Data` : `${minYear}-${maxYear} Data`;
            }

            // Initial display
            applyFilters();
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('resultsBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load data. Please refresh the page.
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    function populateYearDropdown() {
        const select = document.getElementById('yearFilter');
        availableYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            select.appendChild(option);
        });
    }

    function populateTopicDropdown() {
        const select = document.getElementById('topicFilter');
        availableTopics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            select.appendChild(option);
        });
    }

    function setupEventListeners() {
        // Search input with debounce
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentOffset = 0;
                applyFilters();
            }, 300);
        });

        // Filter changes
        ['yearFilter', 'topicFilter', 'meetingTypeFilter', 'outcomeFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                currentOffset = 0;
                applyFilters();
                updateURL();
            });
        });

        // Clear filters
        document.getElementById('clearFilters').addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('topicFilter').value = '';
            document.getElementById('meetingTypeFilter').value = '';
            document.getElementById('outcomeFilter').value = '';
            currentOffset = 0;
            window.history.pushState({}, '', window.location.pathname);
            applyFilters();
        });

        // Sortable columns
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.sort;
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = column === 'meeting_date' ? 'desc' : 'asc';
                }
                currentOffset = 0;
                updateSortIcons();
                applyFilters();
            });
        });

        // Pagination event delegation
        document.getElementById('pagination').addEventListener('click', function(e) {
            e.preventDefault();
            const link = e.target.closest('a.page-link');
            if (link && !link.closest('.disabled')) {
                const offset = parseInt(link.getAttribute('data-offset'), 10);
                if (!isNaN(offset) && offset >= 0) {
                    currentOffset = offset;
                    applyFilters();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });
    }

    function applyFiltersFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const q = urlParams.get('q');
        const year = urlParams.get('year');
        const topic = urlParams.get('topic');
        const type = urlParams.get('type');
        const outcome = urlParams.get('outcome');

        if (q) document.getElementById('searchInput').value = q;
        if (year) document.getElementById('yearFilter').value = year;
        if (topic) document.getElementById('topicFilter').value = topic;
        if (type) document.getElementById('meetingTypeFilter').value = type;
        if (outcome) document.getElementById('outcomeFilter').value = outcome;
    }

    function updateURL() {
        const params = new URLSearchParams();
        const search = document.getElementById('searchInput').value.trim();
        const year = document.getElementById('yearFilter').value;
        const topic = document.getElementById('topicFilter').value;
        const type = document.getElementById('meetingTypeFilter').value;
        const outcome = document.getElementById('outcomeFilter').value;

        if (search) params.set('q', search);
        if (year) params.set('year', year);
        if (topic) params.set('topic', topic);
        if (type) params.set('type', type);
        if (outcome) params.set('outcome', outcome);

        const url = params.toString() ? `?${params.toString()}` : window.location.pathname;
        window.history.pushState({}, '', url);
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.trim().toLowerCase();
        const year = document.getElementById('yearFilter').value;
        const topic = document.getElementById('topicFilter').value;
        const meetingType = document.getElementById('meetingTypeFilter').value;
        const outcome = document.getElementById('outcomeFilter').value;

        // Filter votes
        filteredVotes = allVotes.filter(vote => {
            // Year filter
            if (year) {
                const voteYear = new Date(vote.meeting_date).getFullYear();
                if (voteYear !== parseInt(year)) return false;
            }

            // Topic filter
            if (topic && vote.section !== topic) return false;

            // Meeting type filter
            if (meetingType && vote.meeting_type !== meetingType) return false;

            // Outcome filter
            if (outcome && vote.outcome !== outcome) return false;

            // Search filter
            if (search) {
                const title = (vote.title || '').toLowerCase();
                const section = (vote.section || '').toLowerCase();
                const itemNumber = (vote.item_number || '').toLowerCase();
                if (!title.includes(search) && !section.includes(search) && !itemNumber.includes(search)) {
                    return false;
                }
            }

            return true;
        });

        // Sort
        filteredVotes.sort((a, b) => {
            let aVal = a[sortColumn] || '';
            let bVal = b[sortColumn] || '';

            if (sortColumn === 'meeting_date') {
                aVal = new Date(aVal).getTime();
                bVal = new Date(bVal).getTime();
            } else if (sortColumn === 'item_number') {
                // Extract numeric part for proper sorting
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            } else {
                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
            }

            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        // Update KPIs
        updateKPIs();

        // Display results
        displayResults();

        // Update pagination
        updatePagination();

        // Update URL
        updateURL();
    }

    function updateKPIs() {
        // Count unique meetings in filtered results
        const meetings = new Set(filteredVotes.map(v => v.meeting_date));
        document.getElementById('kpiMeetings').textContent = meetings.size.toLocaleString();
        document.getElementById('kpiVotes').textContent = allVotes.length.toLocaleString();

        // Pass rate
        const passed = filteredVotes.filter(v => v.outcome === 'PASS').length;
        const passRate = filteredVotes.length > 0 ? ((passed / filteredVotes.length) * 100).toFixed(1) : 0;
        document.getElementById('kpiPassRate').textContent = passRate + '%';

        // Filtered count
        document.getElementById('kpiFiltered').textContent = filteredVotes.length.toLocaleString();
    }

    function updateSortIcons() {
        document.querySelectorAll('.sortable').forEach(th => {
            const icon = th.querySelector('.sort-icon');
            if (th.dataset.sort === sortColumn) {
                th.classList.add('active');
                icon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} sort-icon`;
            } else {
                th.classList.remove('active');
                icon.className = 'fas fa-sort sort-icon';
            }
        });
    }

    function displayResults() {
        const tbody = document.getElementById('resultsBody');
        const pageVotes = filteredVotes.slice(currentOffset, currentOffset + pageSize);

        if (pageVotes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p>No agenda items match your filters</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('clearFilters').click()">
                            Clear Filters
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        const search = document.getElementById('searchInput').value.trim();

        tbody.innerHTML = pageVotes.map(vote => `
            <tr>
                <td><small>${formatDate(vote.meeting_date)}</small></td>
                <td><span class="badge bg-light text-dark">${escapeHtml(vote.item_number || '-')}</span></td>
                <td>
                    <a href="vote-detail.html?id=${vote.id}" class="text-decoration-none">
                        ${highlightSearch(truncate(vote.title, 60), search)}
                    </a>
                </td>
                <td><span class="badge bg-secondary">${escapeHtml(vote.section || '-')}</span></td>
                <td><span class="text-muted small">${capitalizeFirst(vote.meeting_type || 'regular')}</span></td>
                <td>${getOutcomeBadge(vote.outcome)}</td>
                <td>
                    <a href="vote-detail.html?id=${vote.id}" class="btn btn-sm btn-outline-primary" aria-label="View vote details">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
        `).join('');
    }

    function updatePagination() {
        const total = filteredVotes.length;
        const totalPages = Math.ceil(total / pageSize);
        const currentPage = Math.floor(currentOffset / pageSize);

        if (totalPages <= 1) {
            document.getElementById('paginationNav').style.display = 'none';
            return;
        }

        document.getElementById('paginationNav').style.display = 'block';
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
        const prevLink = document.createElement('a');
        prevLink.className = 'page-link';
        prevLink.href = '#';
        prevLink.textContent = 'Previous';
        prevLink.setAttribute('data-offset', (currentPage - 1) * pageSize);
        prevLi.appendChild(prevLink);
        pagination.appendChild(prevLi);

        // Page numbers
        for (let i = 0; i < totalPages; i++) {
            if (i === 0 || i === totalPages - 1 || Math.abs(i - currentPage) <= 2) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const link = document.createElement('a');
                link.className = 'page-link';
                link.href = '#';
                link.textContent = i + 1;
                link.setAttribute('data-offset', i * pageSize);
                li.appendChild(link);
                pagination.appendChild(li);
            } else if (Math.abs(i - currentPage) === 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                const span = document.createElement('span');
                span.className = 'page-link';
                span.textContent = '...';
                li.appendChild(span);
                pagination.appendChild(li);
            }
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
        const nextLink = document.createElement('a');
        nextLink.className = 'page-link';
        nextLink.href = '#';
        nextLink.textContent = 'Next';
        nextLink.setAttribute('data-offset', (currentPage + 1) * pageSize);
        nextLi.appendChild(nextLink);
        pagination.appendChild(nextLi);
    }

    // Helper functions
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
    }

    function highlightSearch(text, query) {
        if (!text || !query) return escapeHtml(text) || '';
        const escaped = escapeHtml(text);
        const escapedQuery = escapeHtml(query);
        const regex = new RegExp(`(${escapeRegex(escapedQuery)})`, 'gi');
        return escaped.replace(regex, '<mark>$1</mark>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function getOutcomeBadge(outcome) {
        const badges = {
            'PASS': '<span class="badge bg-success" role="status">Passed</span>',
            'FAIL': '<span class="badge bg-danger" role="status">Failed</span>',
            'CONTINUED': '<span class="badge bg-warning text-dark" role="status">Continued</span>',
            'REMOVED': '<span class="badge bg-secondary" role="status">Removed</span>'
        };
        return badges[outcome] || `<span class="badge bg-light text-dark" role="status">${escapeHtml(outcome || 'Unknown')}</span>`;
    }
    </script>
</body>
</html>
