<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Council Member - CityVotes Santa Ana</title>
    <meta name="description" content="Council member voting profile, alignment data, and vote history.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="profile">
    <meta property="og:title" content="Council Member - CityVotes Santa Ana">
    <meta property="og:description" content="Council member voting profile, alignment data, and vote history.">
    <meta property="og:site_name" content="CityVotes">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Council Member - CityVotes Santa Ana">
    <meta name="twitter:description" content="Council member voting profile, alignment data, and vote history.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ" crossorigin="anonymous"></script>
    <!-- Custom CSS -->
    <link href="css/santa-ana.css" rel="stylesheet">
    <style>
        .alignment-card { transition: transform 0.2s; }
        .alignment-card:hover { transform: translateY(-2px); }
        .filter-section { background-color: #f8f9fa; border-radius: 8px; }
    </style>
</head>
<body>
    <!-- Skip Navigation -->
    <a href="#main-content" class="visually-hidden-focusable skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-sa-blue">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-vote-yea me-2"></i>CityVotes
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="council.html">
                            <i class="fas fa-users me-1"></i>Council
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="meetings.html">
                            <i class="fas fa-calendar me-1"></i>Meetings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="votes.html">
                            <i class="fas fa-check-square me-1"></i>Votes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agenda-search.html">
                            <i class="fas fa-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
                <a href="about.html" class="btn btn-outline-light btn-sm me-3">
                    <i class="fas fa-question-circle me-1"></i>Help
                </a>
                <span class="navbar-text text-sa-gold">
                    <i class="fas fa-map-marker-alt me-1"></i>Santa Ana
                </span>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <nav class="bg-light py-2">
        <div class="container">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="council.html">Council</a></li>
                <li class="breadcrumb-item active" id="breadcrumbName">Loading...</li>
            </ol>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="container my-4">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Member Profile -->
        <div id="memberProfile" style="display: none;">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="me-4">
                            <i class="fas fa-user-circle fa-5x text-sa-blue"></i>
                        </div>
                        <div>
                            <h1 class="mb-1" id="memberName">--</h1>
                            <p class="text-muted mb-0" id="memberPosition">--</p>
                            <small class="text-muted" id="memberTerm">--</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards (filtered stats) -->
            <div class="row mb-4">
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-primary" id="statTotalVotes">--</h3>
                            <small class="text-muted">Matching Votes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-success" id="statAyeRate">--%</h3>
                            <small class="text-muted">Aye Rate</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-info" id="statParticipation">--%</h3>
                            <small class="text-muted">Participation</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-warning" id="statAbsent">--</h3>
                            <small class="text-muted">Absences</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="card mb-4">
                <div class="card-body filter-section">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label for="voteSearchInput" class="form-label small text-muted mb-1">Search Votes</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="voteSearchInput"
                                       placeholder="Search by title..." aria-label="Search votes by title">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="voteTopicFilter" class="form-label small text-muted mb-1">Topic</label>
                            <select class="form-select" id="voteTopicFilter" aria-label="Filter votes by topic">
                                <option value="">All Topics</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="voteYearFilter" class="form-label small text-muted mb-1">Year</label>
                            <select class="form-select" id="voteYearFilter" aria-label="Filter votes by year">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="voteChoiceFilter" class="form-label small text-muted mb-1">Vote</label>
                            <select class="form-select" id="voteChoiceFilter" aria-label="Filter by vote choice">
                                <option value="">All Votes</option>
                                <option value="AYE">Aye</option>
                                <option value="NAY">Nay</option>
                                <option value="ABSTAIN">Abstain</option>
                                <option value="ABSENT">Absent</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-outline-secondary w-100" id="clearVoteFilters" aria-label="Clear vote filters">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vote History and Alignment Side by Side -->
            <div class="row mb-4">
                <!-- Vote History Table -->
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Vote History</h5>
                            <small class="text-muted" id="votesShowing">Loading...</small>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">Item</th>
                                        <th scope="col">Title</th>
                                        <th scope="col">Vote</th>
                                        <th scope="col">Outcome</th>
                                    </tr>
                                </thead>
                                <tbody id="recentVotesTable">
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <div class="card-footer" id="votePaginationContainer" style="display: none;">
                            <nav>
                                <ul class="pagination pagination-sm justify-content-center mb-0" id="votePagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Voting Alignment -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Voting Alignment</h5>
                                <small class="text-muted" id="alignmentRange">--</small>
                            </div>
                            <div id="alignmentSummary" class="mt-2">
                                <div class="progress" style="height: 8px;">
                                    <div id="alignmentBar" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="text-success"><i class="fas fa-thumbs-up me-2"></i>Most Aligned</h6>
                                <div id="mostAligned">
                                    <div class="text-muted small">Loading...</div>
                                </div>
                            </div>
                            <div>
                                <h6 class="text-danger"><i class="fas fa-thumbs-down me-2"></i>Least Aligned</h6>
                                <div id="leastAligned">
                                    <div class="text-muted small">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vote Breakdown Charts (Bottom) -->
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Vote Breakdown</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="voteChart" role="img" aria-label="Doughnut chart showing vote breakdown"></canvas>
                            <div id="voteChartDescription" class="visually-hidden" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Voting Statistics</h5>
                        </div>
                        <div class="card-body" id="voteStats">
                            <!-- Stats will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">Failed to load member data.</span>
            </div>
            <a href="council.html" class="btn btn-primary">Back to Council</a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>CityVotes - Santa Ana Voting Transparency</h6>
                    <p class="text-muted mb-0">Data sourced from official Santa Ana city council meeting records.</p>
                </div>
                <div class="col-md-4 text-end">
                    <p class="mb-0">Want a different city? <a href="contact.html" class="text-sa-gold">Contact us</a></p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Static Data API -->
    <script src="js/api.js"></script>

    <script>
    // State
    let currentMember = null;
    let allMemberVotes = [];
    let filteredMemberVotes = [];
    let alignmentData = null;
    let councilMembers = [];
    let allCouncilVotes = {}; // Map of memberId -> votes array for alignment calculation
    let availableYears = [];
    let availableTopics = [];
    let voteCurrentOffset = 0;
    const votePageSize = 15;
    let voteChart = null;

    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('id');

        if (!memberId) {
            showError('No member ID provided');
            return;
        }

        await loadMember(memberId);
        setupEventListeners();
    });

    function setupEventListeners() {
        // Vote search with debounce
        let searchTimeout;
        document.getElementById('voteSearchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                voteCurrentOffset = 0;
                filterAndUpdateAll();
            }, 300);
        });

        // Vote filter changes
        ['voteTopicFilter', 'voteYearFilter', 'voteChoiceFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                voteCurrentOffset = 0;
                filterAndUpdateAll();
            });
        });

        // Clear vote filters
        document.getElementById('clearVoteFilters').addEventListener('click', function() {
            document.getElementById('voteSearchInput').value = '';
            document.getElementById('voteTopicFilter').value = '';
            document.getElementById('voteYearFilter').value = '';
            document.getElementById('voteChoiceFilter').value = '';
            voteCurrentOffset = 0;
            filterAndUpdateAll();
        });

        // Vote pagination
        document.getElementById('votePagination').addEventListener('click', function(e) {
            e.preventDefault();
            const link = e.target.closest('a.page-link');
            if (link && !link.closest('.disabled')) {
                const offset = parseInt(link.getAttribute('data-offset'), 10);
                if (!isNaN(offset) && offset >= 0) {
                    voteCurrentOffset = offset;
                    displayVotes();
                    updateVotePagination();
                }
            }
        });

    }

    async function loadMember(memberId) {
        try {
            // Load member data, alignment data, and council list in parallel
            const [memberData, alignmentResponse, councilResponse] = await Promise.all([
                CityVotesAPI.getCouncilMember(memberId),
                CityVotesAPI.getAlignment(),
                CityVotesAPI.getCouncil()
            ]);

            if (memberData.success) {
                currentMember = memberData.member;
                allMemberVotes = memberData.member.all_votes || memberData.member.recent_votes || [];
                alignmentData = alignmentResponse;
                councilMembers = councilResponse.members || councilResponse.council_members || [];

                displayMemberHeader(currentMember);
                populateFilterDropdowns();
                filterAndUpdateAll();
                displayAlignment();

                // Load all other council members' votes in background for filtered alignment
                loadAllCouncilVotes(memberId);
            } else {
                showError('Council member not found. The member ID may be invalid.');
            }
        } catch (error) {
            console.error('Error loading member:', error);
            if (error.message.includes('Invalid')) {
                showError(error.message);
            } else if (error.message.includes('Not found')) {
                showError('Council member not found. Please check the ID and try again.');
            } else if (error.message.includes('timed out')) {
                showError('Request timed out. Please check your connection and try again.', true);
            } else {
                showError('Failed to load member data. Please try again later.', true);
            }
        }
    }

    async function loadAllCouncilVotes(currentMemberId) {
        // Load votes for all other council members (for filtered alignment calculation)
        const otherMembers = councilMembers.filter(m => m.id !== parseInt(currentMemberId));

        try {
            const promises = otherMembers.map(m => CityVotesAPI.getCouncilMember(m.id));
            const results = await Promise.all(promises);

            results.forEach((data, idx) => {
                if (data.success && data.member) {
                    const memberId = otherMembers[idx].id;
                    allCouncilVotes[memberId] = data.member.all_votes || data.member.recent_votes || [];
                }
            });

            // If filters are active, recalculate alignment with loaded data
            const hasFilters = document.getElementById('voteSearchInput').value.trim() ||
                              document.getElementById('voteTopicFilter').value ||
                              document.getElementById('voteYearFilter').value ||
                              document.getElementById('voteChoiceFilter').value;

            if (hasFilters) {
                updateAlignment();
            }
        } catch (error) {
            console.error('Error loading council votes for alignment:', error);
        }
    }

    function displayMemberHeader(member) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('memberProfile').style.display = 'block';

        // Header
        document.getElementById('memberName').textContent = member.full_name;
        document.getElementById('breadcrumbName').textContent = member.full_name;
        document.getElementById('memberPosition').textContent = member.position || 'Council Member';
        document.title = `${member.full_name} - CityVotes Santa Ana`;

        if (member.start_date) {
            const start = new Date(member.start_date).getFullYear();
            const end = member.end_date ? new Date(member.end_date).getFullYear() : 'Present';
            document.getElementById('memberTerm').textContent = `Term: ${start} - ${end}`;
        }
    }

    function populateFilterDropdowns() {
        // Extract unique years and topics from votes
        const years = new Set();
        const topics = new Set();

        allMemberVotes.forEach(vote => {
            if (vote.meeting_date) {
                years.add(new Date(vote.meeting_date).getFullYear());
            }
            // Collect topics from the topics array
            if (vote.topics && Array.isArray(vote.topics)) {
                vote.topics.forEach(t => topics.add(t));
            }
        });

        availableYears = Array.from(years).sort((a, b) => b - a);
        // Sort topics by name, but put 'General' last
        availableTopics = Array.from(topics).sort((a, b) => {
            if (a === 'General') return 1;
            if (b === 'General') return -1;
            return a.localeCompare(b);
        });

        // Populate year dropdown
        const voteYearSelect = document.getElementById('voteYearFilter');
        availableYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            voteYearSelect.appendChild(option);
        });

        // Populate topic dropdown
        const topicSelect = document.getElementById('voteTopicFilter');
        availableTopics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            topicSelect.appendChild(option);
        });
    }

    function filterAndUpdateAll() {
        const search = document.getElementById('voteSearchInput').value.trim().toLowerCase();
        const topic = document.getElementById('voteTopicFilter').value;
        const year = document.getElementById('voteYearFilter').value;
        const choice = document.getElementById('voteChoiceFilter').value;

        // Filter votes
        filteredMemberVotes = allMemberVotes.filter(vote => {
            // Year filter
            if (year) {
                const voteYear = new Date(vote.meeting_date).getFullYear();
                if (voteYear !== parseInt(year)) return false;
            }

            // Topic filter - check if selected topic is in vote's topics array
            if (topic) {
                const voteTopics = vote.topics || [];
                if (!voteTopics.includes(topic)) return false;
            }

            // Choice filter
            if (choice && vote.vote_choice !== choice) return false;

            // Search filter
            if (search) {
                const title = (vote.title || '').toLowerCase();
                if (!title.includes(search)) return false;
            }

            return true;
        });

        // Update all sections based on filtered data
        updateStats();
        displayVotes();
        updateVotePagination();
        updateCharts();
        updateAlignment();
    }

    function updateStats() {
        // Calculate stats from filtered votes
        const total = filteredMemberVotes.length;
        const ayeCount = filteredMemberVotes.filter(v => v.vote_choice === 'AYE').length;
        const nayCount = filteredMemberVotes.filter(v => v.vote_choice === 'NAY').length;
        const abstainCount = filteredMemberVotes.filter(v => v.vote_choice === 'ABSTAIN').length;
        const absentCount = filteredMemberVotes.filter(v => v.vote_choice === 'ABSENT').length;
        const participated = total - absentCount;

        const ayeRate = total > 0 ? ((ayeCount / total) * 100).toFixed(1) : 0;
        const participationRate = total > 0 ? ((participated / total) * 100).toFixed(1) : 0;

        document.getElementById('statTotalVotes').textContent = total.toLocaleString();
        document.getElementById('statAyeRate').textContent = ayeRate + '%';
        document.getElementById('statParticipation').textContent = participationRate + '%';
        document.getElementById('statAbsent').textContent = absentCount;
    }

    function updateCharts() {
        // Calculate stats from filtered votes
        const total = filteredMemberVotes.length;
        const ayeCount = filteredMemberVotes.filter(v => v.vote_choice === 'AYE').length;
        const nayCount = filteredMemberVotes.filter(v => v.vote_choice === 'NAY').length;
        const abstainCount = filteredMemberVotes.filter(v => v.vote_choice === 'ABSTAIN').length;
        const absentCount = filteredMemberVotes.filter(v => v.vote_choice === 'ABSENT').length;

        const ayePercentage = total > 0 ? ((ayeCount / total) * 100).toFixed(1) : 0;

        // Update vote stats display
        document.getElementById('voteStats').innerHTML = `
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-check text-success me-2"></i>Aye</span>
                    <strong>${ayeCount}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: ${ayePercentage}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-times text-danger me-2"></i>Nay</span>
                    <strong>${nayCount}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-danger" style="width: ${total > 0 ? (nayCount / total * 100).toFixed(1) : 0}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-minus text-warning me-2"></i>Abstain</span>
                    <strong>${abstainCount}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-warning" style="width: ${total > 0 ? (abstainCount / total * 100).toFixed(1) : 0}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-user-slash text-secondary me-2"></i>Absent</span>
                    <strong>${absentCount}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-secondary" style="width: ${total > 0 ? (absentCount / total * 100).toFixed(1) : 0}%"></div>
                </div>
            </div>
        `;

        // Destroy existing chart if exists
        if (voteChart) {
            voteChart.destroy();
        }

        // Create new chart
        voteChart = new Chart(document.getElementById('voteChart'), {
            type: 'doughnut',
            data: {
                labels: ['Aye', 'Nay', 'Abstain', 'Absent'],
                datasets: [{
                    data: [ayeCount, nayCount, abstainCount, absentCount],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Update accessible chart description
        document.getElementById('voteChartDescription').textContent =
            `Vote breakdown: ${ayeCount} Aye votes (${ayePercentage}%), ` +
            `${nayCount} Nay votes, ${abstainCount} Abstain, ${absentCount} Absent.`;
    }

    function displayVotes() {
        const votesTable = document.getElementById('recentVotesTable');
        const pageVotes = filteredMemberVotes.slice(voteCurrentOffset, voteCurrentOffset + votePageSize);

        if (pageVotes.length === 0) {
            votesTable.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p class="mb-0">No votes match your filters</p>
                    </td>
                </tr>
            `;
            document.getElementById('votesShowing').textContent = 'No votes found';
            document.getElementById('votePaginationContainer').style.display = 'none';
            return;
        }

        const search = document.getElementById('voteSearchInput').value.trim();

        votesTable.innerHTML = pageVotes.map(vote => `
            <tr>
                <td><small>${formatDate(vote.meeting_date)}</small></td>
                <td><span class="badge bg-light text-dark">${escapeHtml(vote.item_number)}</span></td>
                <td><a href="vote-detail.html?id=${vote.vote_id}" class="text-decoration-none">${highlightSearch(truncate(vote.title, 40), search)}</a></td>
                <td>${getVoteBadge(vote.vote_choice)}</td>
                <td><span class="badge ${vote.outcome === 'PASS' ? 'bg-success' : 'bg-danger'}" role="status">${vote.outcome === 'PASS' ? 'Passed' : 'Failed'}</span></td>
            </tr>
        `).join('');

        // Update showing text
        const start = voteCurrentOffset + 1;
        const end = Math.min(voteCurrentOffset + pageVotes.length, filteredMemberVotes.length);
        document.getElementById('votesShowing').textContent = `Showing ${start}-${end} of ${filteredMemberVotes.length} votes`;
    }

    function updateVotePagination() {
        const total = filteredMemberVotes.length;
        const totalPages = Math.ceil(total / votePageSize);
        const currentPage = Math.floor(voteCurrentOffset / votePageSize);

        if (totalPages <= 1) {
            document.getElementById('votePaginationContainer').style.display = 'none';
            return;
        }

        document.getElementById('votePaginationContainer').style.display = 'block';
        const pagination = document.getElementById('votePagination');
        pagination.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
        const prevLink = document.createElement('a');
        prevLink.className = 'page-link';
        prevLink.href = '#';
        prevLink.textContent = 'Prev';
        prevLink.setAttribute('data-offset', (currentPage - 1) * votePageSize);
        prevLi.appendChild(prevLink);
        pagination.appendChild(prevLi);

        // Page numbers (show max 5 pages)
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages - 1, currentPage + 2);

        if (startPage > 0) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            const firstLink = document.createElement('a');
            firstLink.className = 'page-link';
            firstLink.href = '#';
            firstLink.textContent = '1';
            firstLink.setAttribute('data-offset', 0);
            firstLi.appendChild(firstLink);
            pagination.appendChild(firstLi);

            if (startPage > 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(ellipsisLi);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            const link = document.createElement('a');
            link.className = 'page-link';
            link.href = '#';
            link.textContent = i + 1;
            link.setAttribute('data-offset', i * votePageSize);
            li.appendChild(link);
            pagination.appendChild(li);
        }

        if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(ellipsisLi);
            }
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            const lastLink = document.createElement('a');
            lastLink.className = 'page-link';
            lastLink.href = '#';
            lastLink.textContent = totalPages;
            lastLink.setAttribute('data-offset', (totalPages - 1) * votePageSize);
            lastLi.appendChild(lastLink);
            pagination.appendChild(lastLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
        const nextLink = document.createElement('a');
        nextLink.className = 'page-link';
        nextLink.href = '#';
        nextLink.textContent = 'Next';
        nextLink.setAttribute('data-offset', (currentPage + 1) * votePageSize);
        nextLi.appendChild(nextLink);
        pagination.appendChild(nextLi);
    }

    function displayAlignment() {
        // Initial load - use pre-computed alignment data
        updateAlignment();
    }

    function updateAlignment() {
        if (!currentMember) return;

        // If no filters active, use pre-computed alignment data
        const hasFilters = document.getElementById('voteSearchInput').value.trim() ||
                          document.getElementById('voteTopicFilter').value ||
                          document.getElementById('voteYearFilter').value ||
                          document.getElementById('voteChoiceFilter').value;

        if (!hasFilters && alignmentData) {
            // Use pre-computed alignment
            const memberLastName = currentMember.full_name.split(' ').pop();
            const pairs = alignmentData.alignment_pairs || [];

            let memberPairs = pairs.filter(p =>
                p.member1 === memberLastName || p.member2 === memberLastName
            ).map(p => ({
                otherMember: p.member1 === memberLastName ? p.member2 : p.member1,
                agreementRate: p.agreement_rate,
                sharedVotes: p.shared_votes,
                agreements: p.agreements
            }));

            memberPairs.sort((a, b) => b.agreementRate - a.agreementRate);
            displayAlignmentResults(memberPairs);
        } else {
            // Calculate alignment from filtered votes
            calculateFilteredAlignment();
        }
    }

    function calculateFilteredAlignment() {
        if (filteredMemberVotes.length === 0) {
            document.getElementById('mostAligned').innerHTML = '<p class="text-muted small">No votes match filters</p>';
            document.getElementById('leastAligned').innerHTML = '<p class="text-muted small">No votes match filters</p>';
            updateAlignmentSummary([]);
            return;
        }

        // Check if we have loaded other council members' votes
        const otherMemberIds = Object.keys(allCouncilVotes);
        if (otherMemberIds.length === 0) {
            // Fall back to pre-computed alignment with note
            const memberLastName = currentMember.full_name.split(' ').pop();
            if (alignmentData) {
                const pairs = alignmentData.alignment_pairs || [];
                let memberPairs = pairs.filter(p =>
                    p.member1 === memberLastName || p.member2 === memberLastName
                ).map(p => ({
                    otherMember: p.member1 === memberLastName ? p.member2 : p.member1,
                    agreementRate: p.agreement_rate,
                    sharedVotes: p.shared_votes,
                    agreements: p.agreements
                }));
                memberPairs.sort((a, b) => b.agreementRate - a.agreementRate);
                displayAlignmentResults(memberPairs, true, 'Loading alignment data...');
            }
            return;
        }

        // Calculate alignment from filtered votes
        // Get the vote_ids from the current member's filtered votes
        const filteredVoteIds = new Set(filteredMemberVotes.map(v => v.vote_id));

        // Build a map of current member's votes: vote_id -> vote_choice
        const currentMemberChoices = {};
        filteredMemberVotes.forEach(v => {
            currentMemberChoices[v.vote_id] = v.vote_choice;
        });

        // Calculate alignment with each other council member
        const memberPairs = [];

        councilMembers.forEach(otherMember => {
            if (otherMember.id === currentMember.id) return;

            const otherVotes = allCouncilVotes[otherMember.id] || [];
            let sharedVotes = 0;
            let agreements = 0;

            otherVotes.forEach(otherVote => {
                // Only consider votes that are in the filtered set
                if (filteredVoteIds.has(otherVote.vote_id)) {
                    const currentChoice = currentMemberChoices[otherVote.vote_id];
                    if (currentChoice && otherVote.vote_choice) {
                        sharedVotes++;
                        if (currentChoice === otherVote.vote_choice) {
                            agreements++;
                        }
                    }
                }
            });

            if (sharedVotes > 0) {
                const agreementRate = ((agreements / sharedVotes) * 100).toFixed(1);
                memberPairs.push({
                    otherMember: otherMember.short_name || otherMember.full_name.split(' ').pop(),
                    agreementRate: parseFloat(agreementRate),
                    sharedVotes: sharedVotes,
                    agreements: agreements
                });
            }
        });

        memberPairs.sort((a, b) => b.agreementRate - a.agreementRate);
        displayAlignmentResults(memberPairs, true, `Based on ${filteredMemberVotes.length} filtered votes`);
    }

    function displayAlignmentResults(memberPairs, isFiltered = false, filterMessage = null) {
        const filterNote = isFiltered && filterMessage
            ? `<p class="text-muted small mb-2"><em>${filterMessage}</em></p>`
            : '';

        // Display most aligned (top 3)
        const mostAligned = memberPairs.slice(0, 3);
        document.getElementById('mostAligned').innerHTML = mostAligned.length > 0
            ? filterNote + mostAligned.map(p => createAlignmentCard(p, 'success')).join('')
            : '<p class="text-muted small">No alignment data available</p>';

        // Display least aligned (bottom 3, reversed)
        const leastAligned = memberPairs.slice(-3).reverse();
        document.getElementById('leastAligned').innerHTML = leastAligned.length > 0
            ? filterNote + leastAligned.map(p => createAlignmentCard(p, 'danger')).join('')
            : '<p class="text-muted small">No alignment data available</p>';

        // Update alignment summary progress bar
        updateAlignmentSummary(memberPairs);
    }

    function updateAlignmentSummary(memberPairs) {
        const alignmentBar = document.getElementById('alignmentBar');
        const alignmentRange = document.getElementById('alignmentRange');

        if (!memberPairs || memberPairs.length === 0) {
            alignmentBar.style.width = '0%';
            alignmentRange.textContent = '--';
            return;
        }

        // Get min and max alignment percentages
        const rates = memberPairs.map(p => p.agreementRate);
        const minRate = Math.min(...rates);
        const maxRate = Math.max(...rates);
        const avgRate = rates.reduce((a, b) => a + b, 0) / rates.length;

        // Set progress bar to average alignment
        alignmentBar.style.width = avgRate + '%';

        // Color the bar based on average alignment
        alignmentBar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        if (avgRate >= 80) {
            alignmentBar.classList.add('bg-success');
        } else if (avgRate >= 60) {
            alignmentBar.classList.add('bg-warning');
        } else {
            alignmentBar.classList.add('bg-danger');
        }

        // Show range
        alignmentRange.textContent = minRate === maxRate
            ? `${minRate}%`
            : `${minRate}-${maxRate}%`;
    }

    function createAlignmentCard(pair, colorClass) {
        // Find the council member to link to
        const member = councilMembers.find(m => m.full_name.includes(pair.otherMember));
        const memberId = member ? member.id : null;

        return `
            <div class="alignment-card d-flex align-items-center justify-content-between p-2 mb-2 border rounded">
                <div>
                    ${memberId
                        ? `<a href="council-member.html?id=${memberId}" class="text-decoration-none fw-medium">${escapeHtml(pair.otherMember)}</a>`
                        : `<span class="fw-medium">${escapeHtml(pair.otherMember)}</span>`
                    }
                    <br>
                    <small class="text-muted">${pair.sharedVotes} shared votes</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-${colorClass}">${pair.agreementRate}%</span>
                </div>
            </div>
        `;
    }

    function showError(message, showRetry = false) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;

        // Add retry button if appropriate
        const errorState = document.getElementById('errorState');
        const existingRetry = errorState.querySelector('.btn-retry');
        if (existingRetry) existingRetry.remove();

        if (showRetry) {
            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn btn-primary me-2 btn-retry';
            retryBtn.innerHTML = '<i class="fas fa-redo me-1"></i>Try Again';
            retryBtn.onclick = () => location.reload();
            errorState.querySelector('.alert').after(retryBtn);
        }
    }

    function getVoteBadge(choice) {
        const badges = {
            'AYE': '<span class="badge bg-success">Aye</span>',
            'NAY': '<span class="badge bg-danger">Nay</span>',
            'ABSTAIN': '<span class="badge bg-warning text-dark">Abstain</span>',
            'ABSENT': '<span class="badge bg-secondary">Absent</span>',
            'RECUSAL': '<span class="badge bg-info">Recusal</span>'
        };
        return badges[choice] || `<span class="badge bg-light text-dark">${escapeHtml(choice)}</span>`;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function truncate(str, len) {
        if (!str) return '';
        const escaped = escapeHtml(str);
        return escaped.length > len ? escaped.substring(0, len) + '...' : escaped;
    }

    function highlightSearch(text, query) {
        if (!text || !query) return escapeHtml(text) || '';
        const escaped = escapeHtml(text);
        const escapedQuery = escapeHtml(query);
        const regex = new RegExp(`(${escapeRegex(escapedQuery)})`, 'gi');
        return escaped.replace(regex, '<mark>$1</mark>');
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    </script>
</body>
</html>
