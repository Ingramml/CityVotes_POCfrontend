<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Council Member - CityVotes Santa Ana</title>
    <meta name="description" content="Council member voting profile and history.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ" crossorigin="anonymous"></script>
    <!-- Custom CSS -->
    <link href="css/santa-ana.css" rel="stylesheet">
</head>
<body>
    <!-- Skip Navigation -->
    <a href="#main-content" class="visually-hidden-focusable skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-sa-blue">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-vote-yea me-2"></i>CityVotes
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="council.html">
                            <i class="fas fa-users me-1"></i>Council
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="meetings.html">
                            <i class="fas fa-calendar me-1"></i>Meetings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="votes.html">
                            <i class="fas fa-check-square me-1"></i>Votes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agenda-search.html">
                            <i class="fas fa-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
                <a href="about.html" class="btn btn-outline-light btn-sm me-3">
                    <i class="fas fa-question-circle me-1"></i>Help
                </a>
                <span class="navbar-text text-sa-gold">
                    <i class="fas fa-map-marker-alt me-1"></i>Santa Ana
                </span>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <nav class="bg-light py-2">
        <div class="container">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="council.html">Council</a></li>
                <li class="breadcrumb-item active" id="breadcrumbName">Loading...</li>
            </ol>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="container my-4">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Member Profile -->
        <div id="memberProfile" style="display: none;">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="me-4">
                            <i class="fas fa-user-circle fa-5x text-sa-blue"></i>
                        </div>
                        <div>
                            <h1 class="mb-1" id="memberName">--</h1>
                            <p class="text-muted mb-0" id="memberPosition">--</p>
                            <small class="text-muted" id="memberTerm">--</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-primary" id="statTotalVotes">--</h3>
                            <small class="text-muted">Total Votes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-success" id="statAyeRate">--%</h3>
                            <small class="text-muted">Aye Rate</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-info" id="statParticipation">--%</h3>
                            <small class="text-muted">Participation</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <h3 class="text-warning" id="statAbsent">--</h3>
                            <small class="text-muted">Absences</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vote Breakdown Chart -->
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Vote Breakdown</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="voteChart" role="img" aria-label="Doughnut chart showing vote breakdown"></canvas>
                            <div id="voteChartDescription" class="visually-hidden" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Voting Statistics</h5>
                        </div>
                        <div class="card-body" id="voteStats">
                            <!-- Stats will be populated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Votes -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Votes</h5>
                    <small class="text-muted" id="votesShowing">Showing 10 most recent</small>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Date</th>
                                <th scope="col">Item</th>
                                <th scope="col">Title</th>
                                <th scope="col">Vote</th>
                                <th scope="col">Outcome</th>
                            </tr>
                        </thead>
                        <tbody id="recentVotesTable">
                        </tbody>
                    </table>
                </div>
                <!-- Pagination for all votes -->
                <div class="card-footer" id="votePaginationContainer" style="display: none;">
                    <nav>
                        <ul class="pagination pagination-sm justify-content-center mb-0" id="votePagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">Failed to load member data.</span>
            </div>
            <a href="council.html" class="btn btn-primary">Back to Council</a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>CityVotes - Santa Ana Voting Transparency</h6>
                    <p class="text-muted mb-0">Data sourced from official Santa Ana city council meeting records.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Static Data API -->
    <script src="js/api.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('id');

        if (!memberId) {
            showError('No member ID provided');
            return;
        }

        await loadMember(memberId);
    });

    async function loadMember(memberId) {
        try {
            const data = await CityVotesAPI.getCouncilMember(memberId);

            if (data.success) {
                displayMember(data.member);
            } else {
                showError('Council member not found. The member ID may be invalid.');
            }
        } catch (error) {
            console.error('Error loading member:', error);
            // Provide specific error messages based on error type
            if (error.message.includes('Invalid')) {
                showError(error.message);
            } else if (error.message.includes('Not found')) {
                showError('Council member not found. Please check the ID and try again.');
            } else if (error.message.includes('timed out')) {
                showError('Request timed out. Please check your connection and try again.', true);
            } else {
                showError('Failed to load member data. Please try again later.', true);
            }
        }
    }

    function displayMember(member) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('memberProfile').style.display = 'block';

        // Header
        document.getElementById('memberName').textContent = member.full_name;
        document.getElementById('breadcrumbName').textContent = member.full_name;
        document.getElementById('memberPosition').textContent = member.position || 'Council Member';
        document.title = `${member.full_name} - CityVotes Santa Ana`;

        if (member.start_date) {
            const start = new Date(member.start_date).getFullYear();
            const end = member.end_date ? new Date(member.end_date).getFullYear() : 'Present';
            document.getElementById('memberTerm').textContent = `Term: ${start} - ${end}`;
        }

        // Stats
        const stats = member.stats;
        document.getElementById('statTotalVotes').textContent = stats.total_votes.toLocaleString();
        document.getElementById('statAyeRate').textContent = stats.aye_percentage + '%';
        document.getElementById('statParticipation').textContent = stats.participation_rate + '%';
        document.getElementById('statAbsent').textContent = stats.absent_count;

        // Vote breakdown stats
        document.getElementById('voteStats').innerHTML = `
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-check text-success me-2"></i>Aye</span>
                    <strong>${stats.aye_count}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: ${stats.aye_percentage}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-times text-danger me-2"></i>Nay</span>
                    <strong>${stats.nay_count}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-danger" style="width: ${(stats.nay_count / stats.total_votes * 100).toFixed(1)}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-minus text-warning me-2"></i>Abstain</span>
                    <strong>${stats.abstain_count}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-warning" style="width: ${(stats.abstain_count / stats.total_votes * 100).toFixed(1)}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-user-slash text-secondary me-2"></i>Absent</span>
                    <strong>${stats.absent_count}</strong>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-secondary" style="width: ${(stats.absent_count / stats.total_votes * 100).toFixed(1)}%"></div>
                </div>
            </div>
            ${stats.recusal_count > 0 ? `
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span><i class="fas fa-ban text-info me-2"></i>Recusal</span>
                    <strong>${stats.recusal_count}</strong>
                </div>
            </div>
            ` : ''}
        `;

        // Chart with accessibility description
        new Chart(document.getElementById('voteChart'), {
            type: 'doughnut',
            data: {
                labels: ['Aye', 'Nay', 'Abstain', 'Absent'],
                datasets: [{
                    data: [stats.aye_count, stats.nay_count, stats.abstain_count, stats.absent_count],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Update accessible chart description
        document.getElementById('voteChartDescription').textContent =
            `Vote breakdown: ${stats.aye_count} Aye votes (${stats.aye_percentage}%), ` +
            `${stats.nay_count} Nay votes, ${stats.abstain_count} Abstain, ${stats.absent_count} Absent.`;

        // Recent votes table
        const votesTable = document.getElementById('recentVotesTable');
        votesTable.innerHTML = member.recent_votes.map(vote => `
            <tr>
                <td><small>${formatDate(vote.meeting_date)}</small></td>
                <td><span class="badge bg-light text-dark">${escapeHtml(vote.item_number)}</span></td>
                <td><a href="vote-detail.html?id=${vote.vote_id}" class="text-decoration-none">${truncate(vote.title, 50)}</a></td>
                <td>${getVoteBadge(vote.vote_choice)}</td>
                <td><span class="badge ${vote.outcome === 'PASS' ? 'bg-success' : 'bg-danger'}" role="status">${vote.outcome === 'PASS' ? 'Passed' : 'Failed'}</span></td>
            </tr>
        `).join('');

        // Show pagination if there are more than 10 votes
        if (member.stats.total_votes > 10) {
            document.getElementById('votePaginationContainer').style.display = 'block';
            document.getElementById('votesShowing').innerHTML = `Showing 10 of ${member.stats.total_votes} votes <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadAllVotes(${member.id}, 0)">View All</button>`;
        }

        // Store member ID for pagination
        window.currentMemberId = member.id;
    }

    // Store all votes for client-side pagination
    let allMemberVotes = [];
    const votePageSize = 20;

    async function loadAllVotes(memberId, offset = 0) {
        // Use cached votes if available
        if (allMemberVotes.length === 0) {
            try {
                const data = await CityVotesAPI.getCouncilMember(memberId);
                if (data.success && data.member.all_votes) {
                    allMemberVotes = data.member.all_votes;
                }
            } catch (error) {
                console.error('Error loading votes:', error);
                return;
            }
        }

        const total = allMemberVotes.length;
        const votes = allMemberVotes.slice(offset, offset + votePageSize);

        const votesTable = document.getElementById('recentVotesTable');
        votesTable.innerHTML = votes.map(vote => `
            <tr>
                <td><small>${formatDate(vote.meeting_date)}</small></td>
                <td><span class="badge bg-light text-dark">${escapeHtml(vote.item_number)}</span></td>
                <td><a href="vote-detail.html?id=${vote.vote_id}" class="text-decoration-none">${truncate(vote.title, 50)}</a></td>
                <td>${getVoteBadge(vote.vote_choice)}</td>
                <td><span class="badge ${vote.outcome === 'PASS' ? 'bg-success' : 'bg-danger'}" role="status">${vote.outcome === 'PASS' ? 'Passed' : 'Failed'}</span></td>
            </tr>
        `).join('');

        // Update showing text
        const start = offset + 1;
        const end = Math.min(offset + votes.length, total);
        document.getElementById('votesShowing').textContent = `Showing ${start}-${end} of ${total} votes`;

        // Update pagination
        updateVotePagination(total, offset, memberId);
    }

    function updateVotePagination(total, currentOffset, memberId) {
        const totalPages = Math.ceil(total / votePageSize);
        const currentPage = Math.floor(currentOffset / votePageSize);

        document.getElementById('votePaginationContainer').style.display = 'block';
        const pagination = document.getElementById('votePagination');

        let html = '';

        // Previous button
        html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadAllVotes(${memberId}, ${(currentPage - 1) * votePageSize}); return false;">Prev</a>
        </li>`;

        // Page numbers (show max 5 pages)
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages - 1, currentPage + 2);

        if (startPage > 0) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAllVotes(${memberId}, 0); return false;">1</a></li>`;
            if (startPage > 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadAllVotes(${memberId}, ${i * votePageSize}); return false;">${i + 1}</a>
            </li>`;
        }

        if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadAllVotes(${memberId}, ${(totalPages - 1) * votePageSize}); return false;">${totalPages}</a></li>`;
        }

        // Next button
        html += `<li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadAllVotes(${memberId}, ${(currentPage + 1) * votePageSize}); return false;">Next</a>
        </li>`;

        pagination.innerHTML = html;
    }

    function showError(message, showRetry = false) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;

        // Add retry button if appropriate
        const errorState = document.getElementById('errorState');
        const existingRetry = errorState.querySelector('.btn-retry');
        if (existingRetry) existingRetry.remove();

        if (showRetry) {
            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn btn-primary me-2 btn-retry';
            retryBtn.innerHTML = '<i class="fas fa-redo me-1"></i>Try Again';
            retryBtn.onclick = () => location.reload();
            errorState.querySelector('.alert').after(retryBtn);
        }
    }

    function getVoteBadge(choice) {
        const badges = {
            'AYE': '<span class="badge bg-success">Aye</span>',
            'NAY': '<span class="badge bg-danger">Nay</span>',
            'ABSTAIN': '<span class="badge bg-warning text-dark">Abstain</span>',
            'ABSENT': '<span class="badge bg-secondary">Absent</span>',
            'RECUSAL': '<span class="badge bg-info">Recusal</span>'
        };
        return badges[choice] || `<span class="badge bg-light text-dark">${choice}</span>`;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // HTML escape function for safe display
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function truncate(str, len) {
        if (!str) return '';
        const escaped = escapeHtml(str);
        return escaped.length > len ? escaped.substring(0, len) + '...' : escaped;
    }
    </script>
</body>
</html>
