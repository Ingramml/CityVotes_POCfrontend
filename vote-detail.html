<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Detail - CityVotes Santa Ana</title>
    <meta name="description" content="Detailed voting record with individual council member votes.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/santa-ana.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-sa-blue">
        <div class="container">
            <a class="navbar-brand" href="home.html">
                <i class="fas fa-vote-yea me-2"></i>CityVotes
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="home.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="council.html">
                            <i class="fas fa-users me-1"></i>Council
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="meetings.html">
                            <i class="fas fa-calendar me-1"></i>Meetings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="votes.html">
                            <i class="fas fa-check-square me-1"></i>Votes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agenda-search.html">
                            <i class="fas fa-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
                <span class="navbar-text text-sa-gold">
                    <i class="fas fa-map-marker-alt me-1"></i>Santa Ana
                </span>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <nav class="bg-light py-2">
        <div class="container">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="home.html">Home</a></li>
                <li class="breadcrumb-item"><a href="votes.html">Votes</a></li>
                <li class="breadcrumb-item active" id="breadcrumbItem">Loading...</li>
            </ol>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Vote Detail -->
        <div id="voteDetail" style="display: none;">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-light text-dark me-2 fs-5" id="itemNumber">--</span>
                        <span class="badge fs-5" id="outcomeBadge">--</span>
                    </div>
                    <h1 id="voteTitle">--</h1>
                    <p class="text-muted" id="voteDescription"></p>

                    <div class="mb-3">
                        <a href="#" id="meetingLink" class="text-decoration-none">
                            <i class="fas fa-calendar-day me-1"></i>
                            <span id="meetingDate">--</span>
                        </a>
                        <span class="text-muted mx-2">|</span>
                        <span class="text-muted" id="meetingType">--</span>
                    </div>
                </div>
            </div>

            <!-- Tally -->
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Vote Tally</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col">
                                    <h2 class="text-success" id="ayeCount">--</h2>
                                    <small class="text-muted">Ayes</small>
                                </div>
                                <div class="col">
                                    <h2 class="text-danger" id="nayCount">--</h2>
                                    <small class="text-muted">Noes</small>
                                </div>
                                <div class="col">
                                    <h2 class="text-warning" id="abstainCount">--</h2>
                                    <small class="text-muted">Abstain</small>
                                </div>
                                <div class="col">
                                    <h2 class="text-secondary" id="absentCount">--</h2>
                                    <small class="text-muted">Absent</small>
                                </div>
                            </div>

                            <!-- Visual bar -->
                            <div class="progress mt-4" style="height: 30px;">
                                <div class="progress-bar bg-success" id="ayeBar" role="progressbar"></div>
                                <div class="progress-bar bg-danger" id="nayBar" role="progressbar"></div>
                                <div class="progress-bar bg-warning" id="abstainBar" role="progressbar"></div>
                                <div class="progress-bar bg-secondary" id="absentBar" role="progressbar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Individual Votes</h5>
                        </div>
                        <div class="card-body" id="memberVotes">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vote by Category -->
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <i class="fas fa-check me-2"></i>Voted Aye
                        </div>
                        <div class="card-body" id="ayeVoters">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <i class="fas fa-times me-2"></i>Voted Nay
                        </div>
                        <div class="card-body" id="nayVoters">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <i class="fas fa-minus me-2"></i>Abstain/Absent
                        </div>
                        <div class="card-body" id="otherVoters">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">Failed to load vote data.</span>
            </div>
            <a href="votes.html" class="btn btn-primary">Back to Votes</a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h6>CityVotes - Santa Ana Voting Transparency</h6>
                    <p class="text-muted mb-0">Data sourced from official Santa Ana city council meeting records.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    const API_BASE = 'http://localhost:8000/api/db';

    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const voteId = urlParams.get('id');

        if (!voteId) {
            showError('No vote ID provided');
            return;
        }

        await loadVote(voteId);
    });

    async function loadVote(voteId) {
        try {
            const response = await fetch(`${API_BASE}/votes/${voteId}`);
            const data = await response.json();

            if (data.success) {
                displayVote(data.vote);
            } else {
                showError('Vote not found');
            }
        } catch (error) {
            console.error('Error loading vote:', error);
            showError('Failed to load vote data. Make sure the backend is running.');
        }
    }

    function displayVote(vote) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('voteDetail').style.display = 'block';

        // Header
        document.getElementById('itemNumber').textContent = vote.item_number;
        document.getElementById('breadcrumbItem').textContent = `Item ${vote.item_number}`;
        document.getElementById('voteTitle').textContent = vote.title || 'No title';
        document.title = `Item ${vote.item_number} - CityVotes Santa Ana`;

        const outcomeBadge = document.getElementById('outcomeBadge');
        outcomeBadge.textContent = vote.outcome;
        outcomeBadge.className = `badge fs-5 ${vote.outcome === 'PASS' ? 'bg-success' : 'bg-danger'}`;

        if (vote.description) {
            document.getElementById('voteDescription').textContent = vote.description;
        }

        document.getElementById('meetingDate').textContent = formatDate(vote.meeting_date);
        document.getElementById('meetingLink').href = `meeting-detail.html?id=${vote.meeting_id}`;
        document.getElementById('meetingType').textContent = `${vote.meeting_type} Meeting`;

        // Tally
        document.getElementById('ayeCount').textContent = vote.ayes;
        document.getElementById('nayCount').textContent = vote.noes;
        document.getElementById('abstainCount').textContent = vote.abstain;
        document.getElementById('absentCount').textContent = vote.absent;

        const total = vote.ayes + vote.noes + vote.abstain + vote.absent;
        document.getElementById('ayeBar').style.width = `${(vote.ayes / total * 100)}%`;
        document.getElementById('nayBar').style.width = `${(vote.noes / total * 100)}%`;
        document.getElementById('abstainBar').style.width = `${(vote.abstain / total * 100)}%`;
        document.getElementById('absentBar').style.width = `${(vote.absent / total * 100)}%`;

        // Member votes list
        const memberVotesDiv = document.getElementById('memberVotes');
        memberVotesDiv.innerHTML = vote.member_votes.map(mv => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <a href="council-member.html?id=${mv.member_id}" class="text-decoration-none">
                    ${mv.full_name}
                </a>
                ${getVoteBadge(mv.vote_choice)}
            </div>
        `).join('');

        // Grouped by vote choice
        const ayeVoters = vote.member_votes.filter(mv => mv.vote_choice === 'AYE');
        const nayVoters = vote.member_votes.filter(mv => mv.vote_choice === 'NAY');
        const otherVoters = vote.member_votes.filter(mv => !['AYE', 'NAY'].includes(mv.vote_choice));

        document.getElementById('ayeVoters').innerHTML = ayeVoters.length > 0
            ? ayeVoters.map(mv => `<a href="council-member.html?id=${mv.member_id}" class="d-block mb-1">${mv.full_name}</a>`).join('')
            : '<span class="text-muted">None</span>';

        document.getElementById('nayVoters').innerHTML = nayVoters.length > 0
            ? nayVoters.map(mv => `<a href="council-member.html?id=${mv.member_id}" class="d-block mb-1">${mv.full_name}</a>`).join('')
            : '<span class="text-muted">None</span>';

        document.getElementById('otherVoters').innerHTML = otherVoters.length > 0
            ? otherVoters.map(mv => `
                <div class="d-flex justify-content-between mb-1">
                    <a href="council-member.html?id=${mv.member_id}">${mv.full_name}</a>
                    <small class="text-muted">${mv.vote_choice}</small>
                </div>
            `).join('')
            : '<span class="text-muted">None</span>';
    }

    function showError(message) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }

    function getVoteBadge(choice) {
        const badges = {
            'AYE': '<span class="badge bg-success">Aye</span>',
            'NAY': '<span class="badge bg-danger">Nay</span>',
            'ABSTAIN': '<span class="badge bg-warning text-dark">Abstain</span>',
            'ABSENT': '<span class="badge bg-secondary">Absent</span>',
            'RECUSAL': '<span class="badge bg-info">Recusal</span>'
        };
        return badges[choice] || `<span class="badge bg-light text-dark">${choice}</span>`;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    </script>
</body>
</html>
