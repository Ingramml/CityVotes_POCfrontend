<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votes - CityVotes Santa Ana</title>
    <meta name="description" content="Search and browse Santa Ana City Council voting records.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link href="css/santa-ana.css" rel="stylesheet">
</head>
<body>
    <!-- Skip Navigation -->
    <a href="#main-content" class="visually-hidden-focusable skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-sa-blue">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-vote-yea me-2"></i>CityVotes
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="council.html">
                            <i class="fas fa-users me-1"></i>Council
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="meetings.html">
                            <i class="fas fa-calendar me-1"></i>Meetings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="votes.html">
                            <i class="fas fa-check-square me-1"></i>Votes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agenda-search.html">
                            <i class="fas fa-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
                <a href="about.html" class="btn btn-outline-light btn-sm me-3">
                    <i class="fas fa-question-circle me-1"></i>Help
                </a>
                <span class="navbar-text text-sa-gold">
                    <i class="fas fa-map-marker-alt me-1"></i>Santa Ana
                </span>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="bg-light py-4">
        <div class="container">
            <h1><i class="fas fa-check-square me-2"></i>Vote Search</h1>
            <p class="text-muted mb-0">Search and filter Santa Ana City Council voting records</p>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container my-4">
        <!-- Search and Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label for="searchInput" class="visually-hidden">Search votes</label>
                        <div class="input-group">
                            <span class="input-group-text" aria-hidden="true"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search titles and descriptions..." aria-label="Search titles and descriptions">
                            <button class="btn btn-primary" onclick="searchVotes()" type="button">Search</button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="yearFilter" class="visually-hidden">Filter by year</label>
                        <select class="form-select" id="yearFilter" onchange="handleYearChange()" aria-label="Filter by year">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="outcomeFilter" class="visually-hidden">Filter by outcome</label>
                        <select class="form-select" id="outcomeFilter" onchange="searchVotes()" aria-label="Filter by outcome">
                            <option value="">All Outcomes</option>
                            <option value="PASS">Passed</option>
                            <option value="FAIL">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" type="button">
                            <i class="fas fa-times me-1" aria-hidden="true"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Count -->
        <div class="d-flex justify-content-between align-items-center mb-3" aria-live="polite" aria-atomic="true">
            <h5 class="mb-0" id="resultsCount">Loading...</h5>
        </div>

        <!-- Votes Table -->
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">Item</th>
                            <th scope="col">Title</th>
                            <th scope="col">Outcome</th>
                            <th scope="col">Tally</th>
                            <th scope="col"><span class="visually-hidden">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody id="votesTable">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="mt-4" id="paginationNav" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>CityVotes - Santa Ana Voting Transparency</h6>
                    <p class="text-muted mb-0">Data sourced from official Santa Ana city council meeting records.</p>
                </div>
                <div class="col-md-4 text-end">
                    <p class="mb-0">Want a different city? <a href="contact.html" class="text-sa-gold">Contact us</a></p>
                </div>
                <div class="col-md-2 text-end">
                    <span class="text-muted">2024 Data</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Static Data API -->
    <script src="js/api.js"></script>

    <script>
    let allVotes = [];
    let votesCache = {}; // Cache votes by year for performance
    let availableYears = [];
    const pageSize = 20;
    let currentOffset = 0;
    let currentYear = null;
    let isLoadingAll = false;

    document.addEventListener('DOMContentLoaded', async function() {
        // Check URL params for year filter
        const urlParams = new URLSearchParams(window.location.search);
        const yearParam = urlParams.get('year');
        if (yearParam) {
            currentYear = parseInt(yearParam);
        }

        await initializeVotes();

        // Enter key to search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchVotes();
            }
        });
    });

    async function initializeVotes() {
        try {
            // First load the index to get available years
            const indexData = await CityVotesAPI.getVotesIndex();
            availableYears = indexData.available_years;

            // Populate year dropdown
            const yearSelect = document.getElementById('yearFilter');
            availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            });

            // Load only the selected year (or most recent if none selected)
            const yearToLoad = currentYear || availableYears[0];
            await loadVotesForYear(yearToLoad);

            // Set year filter if we auto-selected
            if (!currentYear) {
                yearSelect.value = yearToLoad;
            }

            renderVotes(0);
        } catch (error) {
            console.error('Error initializing votes:', error);
            // Fallback to loading all votes
            await loadAllVotes();
        }
    }

    async function loadVotesForYear(year) {
        if (votesCache[year]) {
            allVotes = votesCache[year];
            return;
        }

        try {
            const data = await CityVotesAPI.getVotesByYear(year);
            if (data.success) {
                votesCache[year] = data.votes;
                allVotes = data.votes;
            }
        } catch (error) {
            console.error(`Error loading votes for ${year}:`, error);
            throw error;
        }
    }

    async function loadAllVotes() {
        if (isLoadingAll) return;
        isLoadingAll = true;

        try {
            // Load all years and combine
            const allYearVotes = [];
            for (const year of availableYears) {
                if (!votesCache[year]) {
                    const data = await CityVotesAPI.getVotesByYear(year);
                    if (data.success) {
                        votesCache[year] = data.votes;
                    }
                }
                allYearVotes.push(...(votesCache[year] || []));
            }
            allVotes = allYearVotes;
        } catch (error) {
            console.error('Error loading all votes:', error);
            // Ultimate fallback - load from full votes.json
            const data = await CityVotesAPI.getVotes();
            if (data.success) {
                allVotes = data.votes;
            }
        }
    }

    async function handleYearChange() {
        const year = document.getElementById('yearFilter').value;

        if (!year) {
            // Load all years
            document.getElementById('resultsCount').textContent = 'Loading all years...';
            await loadAllVotes();
        } else {
            // Load specific year
            document.getElementById('resultsCount').textContent = `Loading ${year}...`;
            await loadVotesForYear(parseInt(year));
        }

        renderVotes(0);
    }

    async function loadVotes() {
        // Deprecated - kept for backwards compatibility
        await initializeVotes();
    }

    function searchVotes() {
        renderVotes(0);
    }

    async function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('outcomeFilter').value = '';
        document.getElementById('yearFilter').value = '';
        currentYear = null;
        // Update URL
        window.history.pushState({}, '', window.location.pathname);
        // Load all years when filters cleared
        await loadAllVotes();
        renderVotes(0);
    }

    function renderVotes(offset = 0) {
        currentOffset = offset;
        const search = document.getElementById('searchInput').value.toLowerCase();
        const outcome = document.getElementById('outcomeFilter').value;
        const year = document.getElementById('yearFilter').value;

        // Filter votes
        let filteredVotes = allVotes.filter(vote => {
            let matches = true;

            // Search filter
            if (search) {
                const titleMatch = vote.title && vote.title.toLowerCase().includes(search);
                const descMatch = vote.description && vote.description.toLowerCase().includes(search);
                matches = matches && (titleMatch || descMatch);
            }

            // Outcome filter
            if (outcome) {
                matches = matches && vote.outcome === outcome;
            }

            // Year filter
            if (year) {
                const voteYear = new Date(vote.meeting_date).getFullYear();
                matches = matches && voteYear === parseInt(year);
            }

            return matches;
        });

        // Paginate
        const paginatedVotes = filteredVotes.slice(offset, offset + pageSize);

        const table = document.getElementById('votesTable');
        if (paginatedVotes.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p class="mb-0">No votes found matching your criteria</p>
                    </td>
                </tr>
            `;
        } else {
            table.innerHTML = paginatedVotes.map(vote => `
                <tr>
                    <td>
                        <small>${formatDate(vote.meeting_date)}</small>
                        <div class="text-muted" style="font-size: 0.75rem;">${vote.meeting_type}</div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${vote.item_number}</span>
                    </td>
                    <td>
                        <a href="vote-detail.html?id=${vote.id}" class="text-decoration-none">
                            ${truncate(vote.title, 60)}
                        </a>
                    </td>
                    <td>
                        <span class="badge ${vote.outcome === 'PASS' ? 'bg-success' : 'bg-danger'}" role="status">${vote.outcome === 'PASS' ? 'Passed' : 'Failed'}</span>
                    </td>
                    <td>
                        <span class="text-success">${vote.ayes}</span>-<span class="text-danger">${vote.noes}</span>-<span class="text-secondary">${vote.abstain}</span>
                    </td>
                    <td>
                        <a href="vote-detail.html?id=${vote.id}" class="btn btn-sm btn-outline-primary" aria-label="View details for vote ${vote.item_number}" title="View details">
                            <i class="fas fa-eye" aria-hidden="true"></i>
                            <span class="visually-hidden">View vote details</span>
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('resultsCount').textContent =
            `Showing ${paginatedVotes.length} of ${filteredVotes.length.toLocaleString()} votes`;

        updatePagination(filteredVotes.length, offset);
    }

    function updatePagination(total, currentOffset) {
        const totalPages = Math.ceil(total / pageSize);
        const currentPage = Math.floor(currentOffset / pageSize);

        if (totalPages <= 1) {
            document.getElementById('paginationNav').style.display = 'none';
            return;
        }

        document.getElementById('paginationNav').style.display = 'block';
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
        const prevLink = document.createElement('a');
        prevLink.className = 'page-link';
        prevLink.href = '#';
        prevLink.textContent = 'Previous';
        prevLink.setAttribute('data-offset', (currentPage - 1) * pageSize);
        prevLi.appendChild(prevLink);
        pagination.appendChild(prevLi);

        // Page numbers
        for (let i = 0; i < totalPages; i++) {
            if (i === 0 || i === totalPages - 1 || Math.abs(i - currentPage) <= 2) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const link = document.createElement('a');
                link.className = 'page-link';
                link.href = '#';
                link.textContent = i + 1;
                link.setAttribute('data-offset', i * pageSize);
                li.appendChild(link);
                pagination.appendChild(li);
            } else if (Math.abs(i - currentPage) === 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                const span = document.createElement('span');
                span.className = 'page-link';
                span.textContent = '...';
                li.appendChild(span);
                pagination.appendChild(li);
            }
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
        const nextLink = document.createElement('a');
        nextLink.className = 'page-link';
        nextLink.href = '#';
        nextLink.textContent = 'Next';
        nextLink.setAttribute('data-offset', (currentPage + 1) * pageSize);
        nextLi.appendChild(nextLink);
        pagination.appendChild(nextLi);
    }

    // Event delegation for pagination clicks (XSS-safe)
    document.getElementById('pagination').addEventListener('click', function(e) {
        e.preventDefault();
        const link = e.target.closest('a.page-link');
        if (link && !link.closest('.disabled')) {
            const offset = parseInt(link.getAttribute('data-offset'), 10);
            if (!isNaN(offset) && offset >= 0) {
                renderVotes(offset);
            }
        }
    });

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // HTML escape function for safe display
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function truncate(str, len) {
        if (!str) return '';
        const escaped = escapeHtml(str);
        return escaped.length > len ? escaped.substring(0, len) + '...' : escaped;
    }
    </script>
</body>
</html>
