<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votes - CityVotes Santa Ana</title>
    <meta name="description" content="Search and browse Santa Ana City Council voting records.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/santa-ana.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-sa-blue">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-vote-yea me-2"></i>CityVotes
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="council.html">
                            <i class="fas fa-users me-1"></i>Council
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="meetings.html">
                            <i class="fas fa-calendar me-1"></i>Meetings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="votes.html">
                            <i class="fas fa-check-square me-1"></i>Votes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agenda-search.html">
                            <i class="fas fa-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
                <span class="navbar-text text-sa-gold">
                    <i class="fas fa-map-marker-alt me-1"></i>Santa Ana
                </span>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="bg-light py-4">
        <div class="container">
            <h1><i class="fas fa-check-square me-2"></i>Vote Search</h1>
            <p class="text-muted mb-0">Search and filter Santa Ana City Council voting records</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container my-4">
        <!-- Search and Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search titles and descriptions...">
                            <button class="btn btn-primary" onclick="searchVotes()">Search</button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="yearFilter" onchange="searchVotes()">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="outcomeFilter" onchange="searchVotes()">
                            <option value="">All Outcomes</option>
                            <option value="PASS">Passed</option>
                            <option value="FAIL">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Count -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0" id="resultsCount">Loading...</h5>
        </div>

        <!-- Votes Table -->
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Item</th>
                            <th>Title</th>
                            <th>Outcome</th>
                            <th>Tally</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="votesTable">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="mt-4" id="paginationNav" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h6>CityVotes - Santa Ana Voting Transparency</h6>
                    <p class="text-muted mb-0">Data sourced from official Santa Ana city council meeting records.</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="text-muted">2024 Data</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Static Data API -->
    <script src="js/api.js"></script>

    <script>
    let allVotes = [];
    const pageSize = 20;
    let currentOffset = 0;
    let currentYear = null;

    document.addEventListener('DOMContentLoaded', async function() {
        // Check URL params for year filter
        const urlParams = new URLSearchParams(window.location.search);
        const yearParam = urlParams.get('year');
        if (yearParam) {
            currentYear = parseInt(yearParam);
        }

        await loadVotes();

        // Enter key to search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchVotes();
            }
        });
    });

    async function loadVotes() {
        try {
            const data = await CityVotesAPI.getVotes();

            if (data.success) {
                allVotes = data.votes;

                // Extract unique years from votes and populate dropdown
                const yearSelect = document.getElementById('yearFilter');
                if (yearSelect.options.length <= 1) {
                    const years = new Set();
                    allVotes.forEach(vote => {
                        if (vote.meeting_date) {
                            years.add(new Date(vote.meeting_date).getFullYear());
                        }
                    });
                    const sortedYears = Array.from(years).sort((a, b) => b - a);
                    sortedYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === currentYear) option.selected = true;
                        yearSelect.appendChild(option);
                    });
                }

                renderVotes(0);
            }
        } catch (error) {
            console.error('Error loading votes:', error);
            document.getElementById('votesTable').innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="alert alert-danger mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load votes.
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    function searchVotes() {
        renderVotes(0);
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('outcomeFilter').value = '';
        document.getElementById('yearFilter').value = '';
        currentYear = null;
        // Update URL
        window.history.pushState({}, '', window.location.pathname);
        renderVotes(0);
    }

    function renderVotes(offset = 0) {
        currentOffset = offset;
        const search = document.getElementById('searchInput').value.toLowerCase();
        const outcome = document.getElementById('outcomeFilter').value;
        const year = document.getElementById('yearFilter').value;

        // Filter votes
        let filteredVotes = allVotes.filter(vote => {
            let matches = true;

            // Search filter
            if (search) {
                const titleMatch = vote.title && vote.title.toLowerCase().includes(search);
                const descMatch = vote.description && vote.description.toLowerCase().includes(search);
                matches = matches && (titleMatch || descMatch);
            }

            // Outcome filter
            if (outcome) {
                matches = matches && vote.outcome === outcome;
            }

            // Year filter
            if (year) {
                const voteYear = new Date(vote.meeting_date).getFullYear();
                matches = matches && voteYear === parseInt(year);
            }

            return matches;
        });

        // Paginate
        const paginatedVotes = filteredVotes.slice(offset, offset + pageSize);

        const table = document.getElementById('votesTable');
        if (paginatedVotes.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p class="mb-0">No votes found matching your criteria</p>
                    </td>
                </tr>
            `;
        } else {
            table.innerHTML = paginatedVotes.map(vote => `
                <tr>
                    <td>
                        <small>${formatDate(vote.meeting_date)}</small>
                        <div class="text-muted" style="font-size: 0.75rem;">${vote.meeting_type}</div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${vote.item_number}</span>
                    </td>
                    <td>
                        <a href="vote-detail.html?id=${vote.id}" class="text-decoration-none">
                            ${truncate(vote.title, 60)}
                        </a>
                    </td>
                    <td>
                        <span class="badge ${vote.outcome === 'PASS' ? 'bg-success' : 'bg-danger'}">${vote.outcome}</span>
                    </td>
                    <td>
                        <span class="text-success">${vote.ayes}</span>-<span class="text-danger">${vote.noes}</span>-<span class="text-secondary">${vote.abstain}</span>
                    </td>
                    <td>
                        <a href="vote-detail.html?id=${vote.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('resultsCount').textContent =
            `Showing ${paginatedVotes.length} of ${filteredVotes.length.toLocaleString()} votes`;

        updatePagination(filteredVotes.length, offset);
    }

    function updatePagination(total, currentOffset) {
        const totalPages = Math.ceil(total / pageSize);
        const currentPage = Math.floor(currentOffset / pageSize);

        if (totalPages <= 1) {
            document.getElementById('paginationNav').style.display = 'none';
            return;
        }

        document.getElementById('paginationNav').style.display = 'block';
        const pagination = document.getElementById('pagination');

        let html = '';

        // Previous button
        html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="renderVotes(${(currentPage - 1) * pageSize}); return false;">Previous</a>
        </li>`;

        // Page numbers
        for (let i = 0; i < totalPages; i++) {
            if (i === 0 || i === totalPages - 1 || Math.abs(i - currentPage) <= 2) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="renderVotes(${i * pageSize}); return false;">${i + 1}</a>
                </li>`;
            } else if (Math.abs(i - currentPage) === 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        // Next button
        html += `<li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="renderVotes(${(currentPage + 1) * pageSize}); return false;">Next</a>
        </li>`;

        pagination.innerHTML = html;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
    }
    </script>
</body>
</html>
