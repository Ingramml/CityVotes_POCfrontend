<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Detail - CityVotes Santa Ana</title>
    <meta name="description" content="Santa Ana City Council meeting details and voting records.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link href="css/santa-ana.css" rel="stylesheet">
</head>
<body>
    <!-- Skip Navigation -->
    <a href="#main-content" class="visually-hidden-focusable skip-link">Skip to main content</a>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-sa-blue">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-vote-yea me-2"></i>CityVotes
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="council.html">
                            <i class="fas fa-users me-1"></i>Council
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="meetings.html">
                            <i class="fas fa-calendar me-1"></i>Meetings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="votes.html">
                            <i class="fas fa-check-square me-1"></i>Votes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agenda-search.html">
                            <i class="fas fa-search me-1"></i>Search
                        </a>
                    </li>
                </ul>
                <a href="about.html" class="btn btn-outline-light btn-sm me-3">
                    <i class="fas fa-question-circle me-1"></i>Help
                </a>
                <span class="navbar-text text-sa-gold">
                    <i class="fas fa-map-marker-alt me-1"></i>Santa Ana
                </span>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <nav class="bg-light py-2">
        <div class="container">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="meetings.html">Meetings</a></li>
                <li class="breadcrumb-item active" id="breadcrumbDate">Loading...</li>
            </ol>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="container my-4">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Meeting Detail -->
        <div id="meetingDetail" style="display: none;">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 id="meetingTitle">
                        <i class="fas fa-calendar-day me-2"></i>
                        <span id="meetingDate">--</span>
                    </h1>
                    <p class="text-muted mb-3" id="meetingType">--</p>

                    <!-- Document Links -->
                    <div id="documentLinks" class="mb-3">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary" id="statVotes">--</h3>
                            <small class="text-muted">Votes Taken</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success" id="statPassed">--</h3>
                            <small class="text-muted">Passed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-info" id="statItems">--</h3>
                            <small class="text-muted">Agenda Items</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agenda Items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Agenda Items & Votes</h5>
                </div>
                <div class="list-group list-group-flush" id="agendaItems">
                    <!-- Will be populated -->
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">Failed to load meeting data.</span>
            </div>
            <a href="meetings.html" class="btn btn-primary">Back to Meetings</a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>CityVotes - Santa Ana Voting Transparency</h6>
                    <p class="text-muted mb-0">Data sourced from official Santa Ana city council meeting records.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <!-- Static Data API -->
    <script src="js/api.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const meetingId = urlParams.get('id');

        if (!meetingId) {
            showError('No meeting ID provided');
            return;
        }

        await loadMeeting(meetingId);
    });

    async function loadMeeting(meetingId) {
        try {
            const data = await CityVotesAPI.getMeeting(meetingId);

            if (data.success) {
                displayMeeting(data.meeting);
            } else {
                showError('Meeting not found. The meeting ID may be invalid.');
            }
        } catch (error) {
            console.error('Error loading meeting:', error);
            // Provide specific error messages based on error type
            if (error.message.includes('Invalid')) {
                showError(error.message);
            } else if (error.message.includes('Not found')) {
                showError('Meeting not found. Please check the ID and try again.');
            } else if (error.message.includes('timed out')) {
                showError('Request timed out. Please check your connection and try again.', true);
            } else {
                showError('Failed to load meeting data. Please try again later.', true);
            }
        }
    }

    function displayMeeting(meeting) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('meetingDetail').style.display = 'block';

        const dateStr = formatDateLong(meeting.meeting_date);
        document.getElementById('meetingDate').textContent = dateStr;
        document.getElementById('breadcrumbDate').textContent = formatDate(meeting.meeting_date);
        document.getElementById('meetingType').textContent = `${meeting.meeting_type} Meeting`;
        document.title = `${formatDate(meeting.meeting_date)} Meeting - CityVotes Santa Ana`;

        // Document links
        let links = '';
        if (meeting.agenda_url) {
            links += `<a href="${meeting.agenda_url}" target="_blank" class="btn btn-outline-primary me-2 mb-2">
                <i class="fas fa-file-alt me-1"></i>View Agenda
            </a>`;
        }
        if (meeting.minutes_url) {
            links += `<a href="${meeting.minutes_url}" target="_blank" class="btn btn-outline-primary me-2 mb-2">
                <i class="fas fa-file-lines me-1"></i>View Minutes
            </a>`;
        }
        if (meeting.video_url) {
            links += `<a href="${meeting.video_url}" target="_blank" class="btn btn-outline-danger me-2 mb-2">
                <i class="fas fa-video me-1"></i>Watch Video
            </a>`;
        }
        document.getElementById('documentLinks').innerHTML = links || '<span class="text-muted">No documents available</span>';

        // Stats
        const passedCount = meeting.agenda_items.filter(item => item.vote && item.vote.outcome === 'PASS').length;
        document.getElementById('statVotes').textContent = meeting.vote_count;
        document.getElementById('statPassed').textContent = passedCount;
        document.getElementById('statItems').textContent = meeting.agenda_items.length;

        // Agenda items
        const agendaList = document.getElementById('agendaItems');
        agendaList.innerHTML = meeting.agenda_items.map(item => {
            const hasVote = item.vote !== null;
            return `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-light text-dark me-2">${item.item_number}</span>
                                ${item.section ? `<small class="text-muted me-2">${item.section}</small>` : ''}
                            </div>
                            <h6 class="mb-1">${item.title || 'No title'}</h6>
                            ${item.description ? `<p class="text-muted small mb-0">${truncate(item.description, 150)}</p>` : ''}
                        </div>
                        ${hasVote ? `
                            <div class="text-end ms-3">
                                <span class="badge ${item.vote.outcome === 'PASS' ? 'bg-success' : 'bg-danger'} mb-1" role="status">${item.vote.outcome === 'PASS' ? 'Passed' : 'Failed'}</span>
                                <div class="small">
                                    <span class="text-success">${item.vote.ayes}</span>-<span class="text-danger">${item.vote.noes}</span>-<span class="text-secondary">${item.vote.abstain}</span>
                                </div>
                                <a href="vote-detail.html?id=${item.vote.id}" class="btn btn-sm btn-outline-primary mt-1" aria-label="View vote details for item ${escapeHtml(item.item_number)}">
                                    <i class="fas fa-eye" aria-hidden="true"></i> Details
                                </a>
                            </div>
                        ` : '<span class="badge bg-light text-dark">No vote</span>'}
                    </div>
                </div>
            `;
        }).join('');
    }

    function showError(message, showRetry = false) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;

        // Add retry button if appropriate
        const errorState = document.getElementById('errorState');
        const existingRetry = errorState.querySelector('.btn-retry');
        if (existingRetry) existingRetry.remove();

        if (showRetry) {
            const retryBtn = document.createElement('button');
            retryBtn.className = 'btn btn-primary me-2 btn-retry';
            retryBtn.innerHTML = '<i class="fas fa-redo me-1"></i>Try Again';
            retryBtn.onclick = () => location.reload();
            errorState.querySelector('.alert').after(retryBtn);
        }
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatDateLong(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // HTML escape function for safe display
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function truncate(str, len) {
        if (!str) return '';
        const escaped = escapeHtml(str);
        return escaped.length > len ? escaped.substring(0, len) + '...' : escaped;
    }
    </script>
</body>
</html>
